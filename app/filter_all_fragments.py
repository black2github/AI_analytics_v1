# app/filter_all_fragments.py

import logging
from app.content_extractor import create_all_fragments_extractor

logger = logging.getLogger(__name__)


def filter_all_fragments(html: str) -> str:
    """
    Извлекает все фрагменты из HTML возвращая их с гибридной разметкой (Markdown + HTML)
    без учета цвета элементов
    """
    logger.info("[filter_all_fragments] <- {%s}", html[:200] + "...")

    extractor = create_all_fragments_extractor()
    result = extractor.extract(html)

    logger.info("[filter_all_fragments] -> {%s}", result)
    return result


def test_filter_all_fragments():
    """Тестовый метод для проверки работы filter_all_fragments()"""

    # МЕСТО ДЛЯ ВСТАВКИ HTML ФРАГМЕНТА
    html_fragment = '''
        <div class="table-wrap"><table class="wrapped fixed-width confluenceTable" style="width: 68.554%;" resolved=""><colgroup><col style="width: 12.2977%;"><col style="width: 87.7263%;"></colgroup><tbody><tr><td style="text-align: left;" class="confluenceTd"><strong>Зачем нужна ЭФ:</strong></td><td style="text-align: left;" class="confluenceTd"><span style="color: rgb(23,43,77);">Данная ЭФ предназначена для создания/редактирования <a href="/pages/viewpage.action?pageId=42684375">Заявки на управление лимитами по карте</a><br></span></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>Как перейти на ЭФ:</strong></td><td style="text-align: left;" class="confluenceTd"><p>Перейти на данную ЭФ пользователь Клиента может путем вызова функций:</p><ul><li><a href="/pages/viewpage.action?pageId=42673776">[КК_ЛК] Клиент: Функция создания заявки на управление лимитами карты</a></li><li><a href="/pages/viewpage.action?pageId=42674452">[КК_ЛК] Клиент: Функция редактирования заявки на управление лимитами карты</a></li></ul></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>Дополнительные действия, выполняемые при открытии ЭФ:</strong></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><p style="text-align: left;"><span style="color: rgb(0,204,255);"><span style="color: rgb(0,51,102);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c">Шаг 1) Выполняется</span> </span><a href="/pages/viewpage.action?pageId=6363237">Контроль доступности функций создания/редактирования заявки пользователю Клиента</a><span style="color: rgb(153,204,0);"> с передачей атрибутов:</span></span></p><ul><li style="text-align: left;"><span style="color: rgb(153,204,0);">Идентификатор клиента</span></li><li style="text-align: left;"><span style="color: rgb(153,204,0);">Идентификатор пользователя</span></li><li style="text-align: left;"><span style="color: rgb(153,204,0);">Функция</span></li></ul><p><span style="color: rgb(0,51,102);"><strong>Если&nbsp;</strong>контроль пройден,&nbsp;<strong>то&nbsp;</strong>осуществляется переход на шаг&nbsp;№2.</span></p><p><span style="color: rgb(0,51,102);"><strong>Иначе</strong>&nbsp;отображается&nbsp;страница с текстом ошибки в зависимости от непройденного контроля. Процесс завершается.</span></p><p style="text-align: left;"><s><span style="color: rgb(153,204,0);">Шаг 2) Выполняется проверка полномочий пользователя на подписание заявки с использованием <a href="https://confluence.gboteam.ru/pages/viewpage.action?pageId=6364001" style="color: rgb(153,204,0);" rel="nofollow">Функция проверки в ЕСК наличия полномочий пользователя на подпись документа</a> для заявки на управление лимитами. <strong style="letter-spacing: 0.0px;">Если&nbsp;</strong><span style="letter-spacing: 0.0px;">полномочия подтверждены, </span><strong style="letter-spacing: 0.0px;">то </strong><span style="letter-spacing: 0.0px;">пользователь имеет полномочия на подписание, <strong>иначе </strong>- нет.</span></span></s></p><p><s><span style="color: rgb(153,204,0);">Осуществляется переход на шаг №3</span></s></p><p style="text-align: left;"><span style="color: rgb(0,0,0);">Шаг <span style="color: rgb(153,204,0);">2<s>3</s></span>) Выполняется <a href="/pages/viewpage.action?pageId=359930">[ЭП] Функция проверки наличия сертификата ЭП и его принадлежности организации</a><a href="https://confluence.gboteam.ru/pages/viewpage.action?pageId=359930" style="color: rgb(0,0,0);" rel="nofollow">&nbsp;и его принадлежности организации</a><span style="color: rgb(153,204,0);"> с передачей атрибутов:</span></span></p><ul><li><span style="color: rgb(153,204,0);">Идентификатор клиента</span></li><li><span style="color: rgb(153,204,0);">Идентификатор пользователя</span></li></ul><p><span style="color: rgb(0,0,0);"><strong>Если&nbsp;</strong>контроль пройден,&nbsp;<strong>то&nbsp;</strong>осуществляется переход на шаг №<span style="color: rgb(153,204,0);">3<s>4</s></span>.</span></p><p><span style="color: rgb(0,0,0);"><strong>Иначе</strong>, пользователю отображается&nbsp;сообщение&nbsp;в виде&nbsp;"плашки"&nbsp;с текстом ошибки из <span class="inline-comment-marker" data-ref="c1124949-0d0f-4a3d-8a03-b402773e6a28">описания контроля</span> и кнопка&nbsp;"X", при нажатии на которую процесс завершается.</span></p><p style="text-align: left;"><span style="color: rgb(0,204,255);"><span style="color: rgb(0,51,102);">Шаг </span><span style="color: rgb(153,204,0);">3<s>4</s></span><span style="color: rgb(0,51,102);">) Выполняется получение данных карты </span><a href="/pages/viewpage.action?pageId=62260981">ЭКО_Получение данных одной корпоративной карты</a> <span style="color: rgb(0,51,102);">и отображается </span><span style="color: rgb(153,204,0);">форма ввода данных текущей ЭФ</span>: </span></p><ul><li style="text-align: left;"><span style="color: rgb(0,204,255);"><span style="color: rgb(0,0,0);"><s><span style="color: rgb(153,204,0);">текущая ЭФ </span></s>в режиме создания (происходит </span><a href="#id-[КК_ЛК]ЭФКлиента:&quot;Заявканауправлениелимитамикарты&quot;врежимесоздания/редактирования-Функцияинициализациизаявки">инициализация ЭФ), </a><span style="color: rgb(0,51,102);">если ЭФ была вызвана при помощи </span><a href="/pages/viewpage.action?pageId=42673776">[КК_ЛК] Клиент: Функция создания заявки на управление лимитами карты</a>;</span></li><li style="text-align: left;"><span style="color: rgb(0,204,255);"><span style="color: rgb(0,51,102);">в режиме редактирования, если ЭФ была вызвана при помощи </span><a href="/pages/viewpage.action?pageId=42674452">[КК_ЛК] Клиент: Функция редактирования заявки на управление лимитами карты</a>.</span></li></ul></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><span style="color: rgb(153,204,0);"><strong>Дополнительные действия, выполняемые при закрытии формы</strong></span></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><p style="text-align: left;"><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c">При переходе на другую страницу:</span></span></p><ul><li style="text-align: left;"><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c"><strong>Если</strong> <span class="inline-comment-marker" data-ref="6f5e94d6-217f-4137-b245-20e0c0c1735a">в заявке не было изменений согласно <a href="/pages/viewpage.action?pageId=175642752">[КК_ЛК] Процедуре проверки внесенных изменений в заявку</a><span style="color: rgb(0,51,102);"> (версия 2)</span></span>, <strong>то</strong> ЭФ закрывается и осуществляются действия, соответствующие выбранному пункту навигационного меню.</span></span></li><li style="text-align: left;"><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c"><strong><span class="inline-comment-marker valid" data-ref="0bad44c2-2d7c-4c1b-8a6f-5447c00070f2">Иначе</span></strong> <span class="inline-comment-marker" data-ref="898580c9-bcca-4500-b3a2-4c6282bfaaad">о</span>тображается модальное окно с текстом "<span class="inline-comment-marker" data-ref="5011526d-d2ca-406b-a96f-bb298f6075bc">Вы покидаете заявку, сохранить изменения</span>?" и кнопками:</span></span><ul><li style="text-align: left;"><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c">"Сохранить" - при нажатии:</span></span><ul><li style="text-align: left;"><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c"><strong>Если</strong> были получены ошибки согласно <a href="/pages/viewpage.action?pageId=175642752">[КК_ЛК] Процедуре проверки внесенных изменений в заявку</a>, <strong>то</strong> пользователю <span style="color: rgb(153,204,0);">отображается уведомление "Измените хотя бы один лимит"</span></span></span><span style="color: rgb(153,204,0);letter-spacing: 0.0px;">.&nbsp;</span></li><li style="text-align: left;"><span style="color: rgb(153,204,0);"><strong>Иначе </strong>выполняется вызов </span><a href="/pages/viewpage.action?pageId=171916142">[КК_ЛК] Процедуры сохранения заявки</a><span style="color: rgb(153,204,0);">.</span></li></ul></li><li style="text-align: left;"><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c">"Не сохранять" - при нажатии: </span></span><ul><li style="text-align: left;"><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c">модальное окно и ЭФ закрываются</span></span></li><li style="text-align: left;"><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c">осуществляются действия, соответствующие выбранному пункту навигационного меню.</span></span></li></ul></li></ul></li></ul><p><span style="color: rgb(153,204,0);"><span class="inline-comment-marker" data-ref="7bf93e19-6336-4e95-80bc-b4c5f90c112c">После успешного сохранения пользователю отображается сообщение "Заявка №&lt;Номер заявки&gt; сохранена" (см. <a href="/pages/viewpage.action?pageId=105416346">Snackbar на ЭФ</a>).</span></span></p></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><span class="inline-comment-marker" data-ref="e710036f-1178-464d-94e7-de0937e36595">Макеты ЭФ:</span></strong></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><p>Новые макеты (добавлены новые лимиты) - <a href="https://www.figma.com/design/PJ9EAuadsOSELTY7nqzWat/%D0%97%D0%B0%D1%8F%D0%B2%D0%BA%D0%B0-%D0%BD%D0%B0-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B-%D0%BA%D0%B0%D1%80%D1%82%D1%8B-%5B%D0%9D%D0%BE%D0%B2%D1%8B%D0%B5-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B%5D?node-id=678-40539&amp;t=YDiN1PCnYZnge7EP-4" class="external-link" rel="nofollow">ссылка</a></p></div><p style="text-align: left;"><br></p><p><strong>Фрактал:</strong></p><p>Размер XL - <a href="https://www.figma.com/design/dCxhrSXmZsdoYCQ5e7iTRU/%5BCLIENT%5D-%D0%97%D0%B0%D1%8F%D0%B2%D0%BA%D0%B0-%D0%BD%D0%B0-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B-%5B%D0%A1%D1%82%D0%B0%D1%80%D1%8B%D0%B5-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B%5D?node-id=7248-39077&amp;t=dhN8U44VQLdRb0HC-0" class="external-link" rel="nofollow">ссылка</a></p><p>Размер L, M&nbsp;-&nbsp;<a href="https://www.figma.com/design/dCxhrSXmZsdoYCQ5e7iTRU/%5BCLIENT%5D-%D0%97%D0%B0%D1%8F%D0%B2%D0%BA%D0%B0-%D0%BD%D0%B0-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B-%5B%D0%A1%D1%82%D0%B0%D1%80%D1%8B%D0%B5-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B%5D?node-id=1796-75670&amp;t=dhN8U44VQLdRb0HC-0" class="external-link" rel="nofollow">ссылка</a></p><p>Размер S -&nbsp;<a href="https://www.figma.com/design/dCxhrSXmZsdoYCQ5e7iTRU/%5BCLIENT%5D-%D0%97%D0%B0%D1%8F%D0%B2%D0%BA%D0%B0-%D0%BD%D0%B0-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B-%5B%D0%A1%D1%82%D0%B0%D1%80%D1%8B%D0%B5-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B%5D?node-id=1848-69810&amp;t=dhN8U44VQLdRb0HC-4" class="external-link" rel="nofollow">ссылка</a></p><p>Размер &nbsp;XS -&nbsp;<a href="https://www.figma.com/design/dCxhrSXmZsdoYCQ5e7iTRU/%5BCLIENT%5D-%D0%97%D0%B0%D1%8F%D0%B2%D0%BA%D0%B0-%D0%BD%D0%B0-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B-%5B%D0%A1%D1%82%D0%B0%D1%80%D1%8B%D0%B5-%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D1%8B%5D?node-id=1858-129273&amp;t=dhN8U44VQLdRb0HC-4" class="external-link" rel="nofollow">ссылка</a></p></td></tr></tbody></table></div>
            '''

    print("=== ВХОДНОЙ HTML ===")
    print(html_fragment)
    print("\n=== РЕЗУЛЬТАТ ОБРАБОТКИ ===")

    result = filter_all_fragments(html_fragment)

    print(f"'{result}'")
    print("\n=== КОНЕЦ ===")


if __name__ == "__main__":
    test_filter_all_fragments()